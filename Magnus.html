<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Magnus Platform — Quick Start</title>
  <meta name="description" content="Chat-style welcome and quick start for Magnus Platform." />
  <style>
    :root{
      --bg: #1a0c00;
      --bg-soft: #2b1202;
      --surface: rgba(255,140,0,0.06);
      --surface-strong: rgba(255,140,0,0.12);
      --border: rgba(255,140,0,0.25);
      --text: #fff6ee;
      --muted: #f2b57f;
      --brand: #ff6600;
      --brand-2: #ff9933;
      --ok: #22c55e;
      --radius-xl: 18px;
      --shadow: 0 10px 30px rgba(0,0,0,0.6);
      --container: min(100%, 900px);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      background:
        radial-gradient(1200px 600px at -10% -10%, rgba(255,102,0,0.45) 0%, transparent 60%),
        radial-gradient(1000px 500px at 110% -10%, rgba(120,60,0,0.35) 0%, transparent 60%),
        linear-gradient(180deg, #120700 0%, #1a0c00 100%);
      color:var(--text);
      display:flex; flex-direction:column;
    }
    header{
      position:sticky; top:0; z-index:5;
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(20,10,0,0.85), rgba(20,10,0,0.35));
      border-bottom: 1px solid var(--border);
    }
    .bar{
      max-width: var(--container); margin:0 auto; padding:14px 16px; display:flex; gap:12px; align-items:center;
    }
    .logo{
      width:36px; height:36px; border-radius:10px;
      background: linear-gradient(135deg, var(--brand), var(--brand-2));
      box-shadow: 0 6px 20px rgba(255,102,0,0.4);
    }
    .title{font-weight:700; letter-spacing:.3px;}
    .sub{margin-left:auto; font-size:.9rem; color:var(--muted);}
    .wrap{flex:1; display:flex; justify-content:center;}
    .chat{width:100%; max-width:var(--container); padding:20px 16px 132px;}
    .bubble{
      max-width: min(85%, 640px);
      padding:12px 14px; border-radius:14px; line-height:1.4;
      box-shadow: var(--shadow);
      font-size: clamp(0.95rem, 2.4vw, 1rem);
    }
    .bot{
      background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04));
      border:1px solid var(--border);
      backdrop-filter: blur(8px);
      border-top-left-radius: 6px;
    }
    .user{
      margin-left:auto;
      background: linear-gradient(135deg, rgba(255,153,51,0.25), rgba(255,102,0,0.18));
      border:1px solid rgba(255,102,0,0.25);
      border-bottom-right-radius: 6px;
    }
    .row{display:flex; margin:12px 0;}
    .avatar{width:34px;height:34px;border-radius:10px;margin-right:10px;flex:0 0 auto;
      background: linear-gradient(135deg, #1f1f1f, #000000);opacity:.9;}
    .row.user-row{justify-content:flex-end}
    .row.user-row .avatar{display:none}
    .card{
      margin-top:8px;
      background: linear-gradient(180deg, rgba(255,140,0,0.12), rgba(255,140,0,0.06));
      border:1px solid var(--border);
      border-radius: var(--radius-xl);
      overflow:hidden;
    }
    .card .head{
      padding:14px 16px;
      background: linear-gradient(180deg, rgba(255,120,0,0.30), rgba(255,120,0,0.08));
      border-bottom:1px solid var(--border);
      font-weight:700;
    }
    .card .body{padding:14px 16px; color:var(--text); overflow-wrap:anywhere;}
    .card ul{margin:10px 0 0 18px}
    .card li{margin:6px 0; color:var(--muted)}
    .actions{
      display:flex; flex-wrap:wrap; gap:10px; padding:14px 16px; border-top:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,102,0,0.18), rgba(255,102,0,0.06));
    }
    .btn{
      appearance:none; border:none; cursor:pointer;
      padding:10px 14px; border-radius:12px; font-weight:700; letter-spacing:.2px;
      transition: transform .08s ease, box-shadow .2s ease, background .2s ease;
      box-shadow: 0 8px 22px rgba(0,0,0,0.35);
      color:#0b1220; font-size: clamp(0.9rem, 2.4vw, 1rem);
    }
    .btn:active{transform: translateY(1px)}
    .btn.primary{background: linear-gradient(135deg, #ff6600, #ff9933)}
    .btn.secondary{background: linear-gradient(135deg, #000000, #333333); color:#f2f2f2;}
    .dock{
      position: fixed; left:0; right:0; bottom:0; z-index:10;
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(20,10,0,0.2), rgba(20,10,0,0.7));
      border-top: 1px solid var(--border);
      padding-bottom: max(0px, env(safe-area-inset-bottom));
    }
    .dock-inner{max-width:var(--container); margin:0 auto; padding:12px 16px; display:flex; gap:10px;}
    .field{
      flex:1; display:flex; gap:10px; align-items:center;
      background: var(--surface);
      border:1px solid var(--border);
      border-radius: 14px; padding:10px 12px;
    }
    .input{flex:1; background: transparent; border:none; outline:none; color:var(--text); font-size:clamp(0.95rem, 2.4vw, 1rem);}
    .send{
      flex:0 0 auto; min-width:110px;
      background: linear-gradient(135deg, #22c55e, #a3e635);
      color:#08210c; border:none; border-radius:12px; padding:10px 14px; font-weight:800; cursor:pointer;
      box-shadow: 0 10px 24px rgba(34,197,94,0.25);
      font-size: clamp(0.9rem, 2.4vw, 1rem);
    }
    .fade-in{animation:fade .24s ease both}
    @keyframes fade{from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:none}}
    @media (min-width:768px){.bubble{padding:14px 16px}.send{min-width:140px}}
    @media (max-width: 480px){.chat{ padding: 14px 10px calc(110px + env(safe-area-inset-bottom)); }.bar{ padding: 10px 10px; }.logo{ width:28px; height:28px; border-radius:8px; }.sub{ display:none; }.bubble{ max-width: 96%; padding:10px 12px; }.avatar{ width:28px; height:28px; margin-right:8px; }.btn{ padding: 9px 12px; }.send{ min-width: 92px; padding: 9px 12px; }.dock-inner{ padding: 10px; gap:8px; }}
    @media (max-width: 360px){.field{ flex-wrap: wrap; }.send{ width: 100%; }}
    @media (min-width: 641px) and (max-width: 1023px){.chat{ padding: 18px 16px calc(140px + env(safe-area-inset-bottom)); }.bubble{ max_width: 88%; }}
    @media (min-width: 1024px){.chat{ padding: 24px 20px calc(160px + env(safe-area-inset-bottom)); }.bubble{ max-width: min(900px, 82%); }:root{ --container: min(100%, 1100px); }}
    .card img{ max-width:100%; height:auto; display:block; }
    .restart-btn{
      margin-left: 10px;
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,140,0,0.12), rgba(255,140,0,0.05));
      color: var(--text);
      font-weight: 700;
      font-size: .85rem;
      cursor: pointer;
    }
    .restart-btn:hover{ filter: brightness(1.05); }
    .field .btn.secondary{ box-shadow:none; }
    /* Revisit badge in navbar */
    .visit-badge{
      margin-left: 10px;
      font-size: .85rem;
      padding: 2px 8px;
      border: 1px solid var(--border);
      border-radius: 999px;
      color: var(--muted);
      background: linear-gradient(180deg, rgba(255,140,0,0.10), rgba(255,140,0,0.04));
    }

    /* Revisit promo popup (image/video) */
    .promo{
      position: fixed;
      inset: 0;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.45);
      padding: 16px;
    }
    .promo-card{
      width: min(92vw, 420px);
      background: linear-gradient(180deg, rgba(0,0,0,0.85), rgba(20,10,0,0.85));
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: 0 18px 40px rgba(0,0,0,0.55);
      overflow: hidden;
    }
    .promo-head{
      display:flex; align-items:center; gap:10px; padding:10px 12px;
      background: linear-gradient(180deg, rgba(255,120,0,0.20), rgba(255,120,0,0.05));
      border-bottom: 1px solid var(--border);
      font-weight: 700;
    }
    .promo-close{
      margin-left:auto; background:none; border:none; color:var(--text); opacity:.8; cursor:pointer; padding:4px; line-height:0;
    }
    .promo-close:hover{ opacity:1 }
    .promo-body{ padding:10px 12px; }
    .promo figure{ margin:0 }
    .promo img, .promo video{ width:100%; height:auto; display:block; border-radius: 12px; border: 1px solid var(--border); }
    .promo figcaption{ margin-top:8px; }
    .promo figcaption h1{ margin:0 0 4px 0; font-size:1.05rem; line-height:1.2 }
    .promo figcaption p{ margin:0; color: var(--muted) }
    @media (max-width: 480px){
      .promo-card{ width: min(94vw, 360px); }
    }

    .mpc-min{margin-left:auto; background:none; border:none; color:var(--text); opacity:.75; cursor:pointer; padding:2px; line-height:0;}
    .mpc-min:hover{opacity:1}
    .mpc-floater.min .mpc-body, .mpc-floater.min .mpc-foot{display:none}
    .mpc-floater.min{width:auto; min-width:120px}
    .mpc-floater.min .mpc-hide{display:none}
    .mpc-hide{padding:6px 8px; border-top:1px solid var(--border); background: linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.15));}
    .mpc-hide-btn{width:100%; appearance:none; border:1px solid var(--border); background: linear-gradient(135deg, #000000, #333333); color:#f2f2f2; border-radius:8px; padding:6px 8px; font-weight:700; cursor:pointer; font-size:.75rem;}
    .mpc-hide-btn:hover{filter:brightness(1.05)}


    /* Floating countdown chat */
    .mpc-floater{position:fixed;left:16px;top:50%;transform:translateY(-50%);z-index:999;width:min(92vw,160px);background:linear-gradient(180deg,rgba(0,0,0,0.85),rgba(20,10,0,0.85));color:var(--text);border:1px solid var(--border);border-radius:12px;box-shadow:0 12px 30px rgba(0,0,0,0.5);backdrop-filter:blur(6px);overflow:hidden;font-size:.78rem;cursor:default;}
    .mpc-head{display:flex;align-items:center;gap:8px;padding:6px 8px;cursor:move;
      background: linear-gradient(180deg, rgba(255,120,0,0.20), rgba(255,120,0,0.05));
      border-bottom: 1px solid var(--border);
      font-weight: 700;
    }
    .mpc-pfp{width:24px;height:24px;border-radius:50%;object-fit:cover;border:1px solid var(--border);background:linear-gradient(135deg,var(--brand),var(--brand-2));flex:0 0 auto;}
    .mpc-body{padding:6px 8px;color:var(--muted);font-size:.76rem;line-height:1.3;}
    .mpc-foot{display:flex;justify-content:space-between;align-items:center;gap:8px;
      padding: 10px 12px;
      border-top: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,102,0,0.15), rgba(255,102,0,0.05));
      font-variant-numeric: tabular-nums;
    }
    .mpc-timer{
      font-weight: 800;
      letter-spacing: 0.5px;
    }
    @media (max-width: 480px){.mpc-floater{ left:10px; right:auto; top:50%; bottom:auto; transform:translateY(-50%); width:auto; }}


    .v-badge{
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      margin-left: 6px;
      border-radius: 50%;
      background: #22c55e; /* green */
      color: #ffffff;
      font-size: 12px;
      line-height: 1;
      font-weight: 900;
      border: 1px solid rgba(255,255,255,0.25);
      box-shadow: 0 4px 10px rgba(34,197,94,0.35);
    }

</style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="logo" aria-hidden="true"></div>
      <div class="title">Magnus Platform <span class="v-badge" aria-label="Verified" title="Verified">✓</span></div>
      <div class="sub">Instant welcome & quick start</div>
    </div>
  </header>
  <main class="wrap">
    <section class="chat" id="chat" aria-live="polite" aria-label="Magnus Platform chat"></section>
  </main>
  <footer class="dock" role="contentinfo" aria-label="Message composer">
    <div class="dock-inner">
      <form id="composer" class="field" autocomplete="off">
        <button id="uploadBtn" type="button" aria-label="Upload image" class="btn secondary" style="padding:8px 10px;min-width:auto;">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M5 20h14a2 2 0 0 0 2-2v-7h-2v7H5V6h7V4H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2z"/><path d="M19 3h-4.586a2 2 0 0 0-1.414.586l-9.414 9.414A2 2 0 0 0 3 14.828V19h4.172a2 2 0 0 0 1.414-.586l9.414-9.414A2 2 0 0 0 19 7.586V3zM8.414 17H5v-3.414L14 4.586V8h3.414L8.414 17z"/></svg>
        </button>
        <input type="file" id="uploadImage" accept="image/*" style="display:none" />
        <input id="msg" class="input" name="message" placeholder="Type here and press Enter…" aria-label="Type your message" required />
        <button class="send" type="submit" aria-label="Send">Send</button>
      </form>
    </div>
  </footer>
  <script>
    const chat = document.getElementById('chat');
    const form = document.getElementById('composer');
    const input = document.getElementById('msg');
    /* === Guard: block composer until Quick Start Form is submitted === */
    let __formSubmittedOK = false;
    (function __enforceFormBeforeChat(){
      try{
        const sendBtn = document.querySelector('.send');
        // Initially lock the composer
        if (!__formSubmittedOK){
          input.disabled = true;
          input.setAttribute('aria-disabled','true');
          input.style.opacity = 0.6;
          if (sendBtn){ sendBtn.disabled = true; sendBtn.style.opacity = 0.6; }
        }
        // Show prompt whenever user tries to use the input before submitting the form
        function __blockIfNotSubmitted(ev){
          if (!__formSubmittedOK){
            ev.preventDefault && ev.preventDefault();
            ev.stopImmediatePropagation && ev.stopImmediatePropagation();
            alert('Please fill the Quick Start Form and submit first.');
            input.blur && input.blur();
            return false;
          }
        }
        ['focus','keydown','input','paste','click'].forEach(evt => input.addEventListener(evt, __blockIfNotSubmitted, true));
        // Intercept composer submit before other handlers
        form.addEventListener('submit', function(e){
          if (!__formSubmittedOK){
            e.preventDefault();
            e.stopImmediatePropagation();
            alert('Please fill the Quick Start Form and submit first.');
            return false;
          }
        }, true);
        // Expose an unlock hook to be called after successful form submission
        window.__unlockChatAfterForm = function(){
          __formSubmittedOK = true;
          input.disabled = false;
          input.setAttribute('aria-disabled','false');
          input.style.opacity = 1;
          if (sendBtn){ sendBtn.disabled = false; sendBtn.style.opacity = 1; }
        };
      }catch(e){}
    })();


    /* lock composer while typing */
    function __composerLock(on){
      try{
        input.disabled = !!on;
        input.setAttribute('aria-disabled', on ? 'true' : 'false');
        input.style.opacity = on ? 0.6 : 1;
        const sendBtn = document.querySelector('.send');
        if (sendBtn){ sendBtn.disabled = !!on; sendBtn.style.opacity = on ? 0.6 : 1; }
      }catch(e){}
    }

    /* === IP-based persistence (added) === */
    let __magnusIP = null;
    let __magnusRestored = false;
    const __NS = 'magnus_chat';

    function __key(suffix=''){
      const ip = __magnusIP || 'unknown';
      return `${__NS}_${ip}${suffix ? '_' + suffix : ''}`;
    }

    async function __getIP(){
      try{
        const res = await fetch('https://api.ipify.org?format=json');
        const data = await res.json();
        __magnusIP = (data && data.ip) ? data.ip : 'unknown';
      }catch(e){
        __magnusIP = 'unknown';
      }
      return __magnusIP;
    }

    function __saveChat(){
      if (!__magnusIP) return;
      try{ localStorage.setItem(__key(), chat.innerHTML); }catch(e){}
    }
    function __saveFlags(){
      if (!__magnusIP) return;
      try{
        localStorage.setItem(__key('flags'), JSON.stringify({
          howItWorksShown: !!window.howItWorksShown,
          paymentDetailsShown: !!window.paymentDetailsShown,
          proofCTAShown: !!window.proofCTAShown,
          expectingCountry: !!window.expectingCountry
        }));
      }catch(e){}
    }
    function __restoreChat(){
      if (!__magnusIP) return;
      try{
        const html = localStorage.getItem(__key());
        const flags = JSON.parse(localStorage.getItem(__key('flags')) || '{}');
        if (html){
          chat.innerHTML = html;
          window.howItWorksShown = flags.howItWorksShown === true || chat.innerHTML.includes("Here’s how <strong>Magnus Platform</strong> works");
          window.paymentDetailsShown = flags.paymentDetailsShown === true || chat.innerHTML.includes('Payment Details —');
          window.proofCTAShown = flags.proofCTAShown === true || chat.innerHTML.toLowerCase().includes('submit proof of payment to get access and start earning');
          window.expectingCountry = flags.expectingCountry === true ? true : false;
          __magnusRestored = true;
        }
      }catch(e){}
    }
    const __mo = new MutationObserver(() => { __saveChat(); __saveFlags(); });
    /* === Countdown floater (added) === */
    function __ensureFloater(){
      if (document.querySelector('.mpc-floater')) return document.querySelector('.mpc-floater');
      const wrap = document.createElement('div');
      wrap.className = 'mpc-floater';
      wrap.innerHTML = `
        <div class="mpc-head">
          <img class="mpc-pfp" src="https://i.pravatar.cc/64?u=magnus_ceo" alt="Magnus CEO" />
          <div>Magnus CEO</div>
          <button class="mpc-min" title="Minimize" aria-label="Minimize" type="button">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M5 12h14v2H5z"/></svg>
          </button>
        </div>
        <div class="mpc-body">
          We are expecting your alert, pay now and get access to your earning dashboard, 60% of your payment will be deposited on your magnus account
        </div>
        <div class="mpc-foot">
          <span>Time left</span>
          <span class="mpc-timer" id="mpc_timer">20:00</span>
        </div>
        <div class="mpc-hide">
          <button class="mpc-hide-btn" type="button">Click here  or drag to remove this popup from covering text</button>
        </div>
      `;
      document.body.appendChild(wrap);
      return wrap;
    }


    // Make floater draggable and minimizable; persist position/minimized per IP
    function __attachFloaterControls(floater){
      if (!floater || floater.__wired) return;
      floater.__wired = true;
      const head = floater.querySelector('.mpc-head');
      const minBtn = floater.querySelector('.mpc-min');
      const hideBtn = floater.querySelector('.mpc-hide-btn');

      // Restore saved position/min state
      try{
        const pos = JSON.parse(localStorage.getItem(__key('floaterPos')) || 'null');
        if (pos && typeof pos.left==='number' && typeof pos.top==='number'){
          floater.style.left = pos.left+'px';
          floater.style.top = pos.top+'px';
          floater.style.right = 'auto';
          floater.style.bottom = 'auto';
          floater.style.transform = 'none';
        }else{
          // Initialize left/top from current rect
          const r = floater.getBoundingClientRect();
          floater.style.left = (r.left)+'px';
          floater.style.top = (r.top)+'px';
          floater.style.right = 'auto';
          floater.style.bottom = 'auto';
          floater.style.transform = 'none';
        }
        const min = localStorage.getItem(__key('floaterMin')) === '1';
        if (min) floater.classList.add('min');
      }catch(e){}

      // Minimize toggle
      if (minBtn){
        minBtn.addEventListener('click', (ev) => {
          ev.stopPropagation();
          floater.classList.toggle('min');
          try{ localStorage.setItem(__key('floaterMin'), floater.classList.contains('min') ? '1' : '0'); }catch(e){}
        });
      }

      // Hide button
      if (hideBtn){ hideBtn.addEventListener('click', () => { floater.remove(); try{ localStorage.removeItem(__key('countdownEnd')); }catch(e){} }); }

      // Dragging
      let drag = null;
      function onDown(ev){
        if (ev.target.closest('.mpc-min')) return; // don't start drag on min icon
        const e = ev.touches ? ev.touches[0] : ev;
        drag = {
          sx: e.clientX,
          sy: e.clientY,
          left: parseFloat(getComputedStyle(floater).left) || 0,
          top: parseFloat(getComputedStyle(floater).top) || 0
        };
        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onUp);
        document.addEventListener('touchmove', onMove, {passive:false});
        document.addEventListener('touchend', onUp);
      }
      function onMove(ev){
        if (!drag) return;
        const e = ev.touches ? ev.touches[0] : ev;
        ev.preventDefault && ev.preventDefault();
        const dx = e.clientX - drag.sx;
        const dy = e.clientY - drag.sy;
        let L = drag.left + dx;
        let T = drag.top + dy;
        // Constrain within viewport
        const w = floater.offsetWidth, h = floater.offsetHeight;
        const vw = window.innerWidth, vh = window.innerHeight;
        L = Math.max(4, Math.min(vw - w - 4, L));
        T = Math.max(4, Math.min(vh - h - 4, T));
        floater.style.left = L + 'px';
        floater.style.top = T + 'px';
      }
      function onUp(){
        if (!drag) return;
        document.removeEventListener('mousemove', onMove);
        document.removeEventListener('mouseup', onUp);
        document.removeEventListener('touchmove', onMove);
        document.removeEventListener('touchend', onUp);
        try{
          localStorage.setItem(__key('floaterPos'), JSON.stringify({left: parseFloat(floater.style.left)||0, top: parseFloat(floater.style.top)||0}));
        }catch(e){}
        drag = null;
      }
      head.addEventListener('mousedown', onDown);
      head.addEventListener('touchstart', onDown, {passive:true});
    }
function __startPaymentCountdown(){
      try{
        const endKey = __key('countdownEnd');
        let end = localStorage.getItem(endKey);
        const now = Date.now();
        if (!end){
          end = now + 20*60*1000; // 20 minutes
          localStorage.setItem(endKey, String(end));
        }else{
          end = parseInt(end, 10);
          if (isNaN(end)){ end = now + 20*60*1000; localStorage.setItem(endKey, String(end)); }
        }

        const floater = __ensureFloater(); __attachFloaterControls(floater);
        const timerEl = floater.querySelector('#mpc_timer');
        function tick(){
          const remain = Math.max(0, end - Date.now());
          const s = Math.floor(remain/1000);
          const mm = Math.floor(s/60).toString().padStart(2,'0');
          const ss = (s%60).toString().padStart(2,'0');
          if (timerEl) timerEl.textContent = `${mm}:${ss}`;
          if (remain <= 0){ clearInterval(iv); }
        }
        tick();
        const iv = setInterval(tick, 1000);
      }catch(e){ /* ignore */ }
    }

    __mo.observe(chat, { childList:true, subtree:true });

    function appendMessage(role, html) {
      const row = document.createElement('div');
      row.className = 'row ' + (role === 'user' ? 'user-row' : 'bot-row') + ' fade-in';
      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      if (role === 'user') avatar.style.display = 'none';
      const bubble = document.createElement('div');
      bubble.className = 'bubble ' + (role === 'user' ? 'user' : 'bot');
      bubble.innerHTML = html;
      row.appendChild(avatar);
      row.appendChild(bubble);
      chat.appendChild(row);
      window.scrollTo({top: document.body.scrollHeight, behavior:'smooth'});
      try{ __saveChat(); __saveFlags(); }catch(e){}
      return bubble;
    }

    function buildCard(headText, bodyHTML, withActions){
      return `<div class="card" role="region" aria-label="${headText}">
        <div class="head">${headText}</div>
        <div class="body">${bodyHTML}</div>
        ${withActions ? `<div class="actions">
            <button class="btn primary" data-action="choose">I Choose this package</button>
            <button class="btn secondary" data-action="ready">I am ready</button>
          </div>` : ``}
      </div>`;
    }

    function proofCardHTML(i){
      return `<div class="card" role="region" aria-label="Proof ${i}">
        <div class="head">Verification & Proof #${i}</div>
        <div class="body">
          <figure style="margin:0">
            <img src="https://picsum.photos/seed/magnus${i}/600/360" alt="Magnus proof ${i}" style="width:100%;height:auto;border-radius:12px;border:1px solid var(--border)" />
            <figcaption style="margin-top:8px">
              <h1 style="margin:0 0 4px 0;font-size:1.05rem;line-height:1.2">Real Platform Proof #${i}</h1>
              <p style="margin:0;color:var(--muted)">Sample evidence image ${i} demonstrating activity and results on Magnus Platform.</p>
            </figcaption>
          </figure>
        </div>
        <div class="actions">
          <button class="btn primary" data-action="choose">I Choose this package</button>
          <button class="btn secondary" data-action="ready">I am ready</button>
          <button class="btn primary" data-action="ready">register with a good coach</button>
        </div>
      </div>`;
    }

    function escapeHTML(str){
      return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
    }

    function greet() {
      if (window.__magnusRestored) { input.focus(); return; }
      appendMessage('bot', `Welcome to Magnus Platform What is your name? Please fill the form with your real name, Your active phone number and Gmail address.`);
      appendMessage('bot', buildCard('Quick Start Form', `
        <form id="quickRegForm" novalidate style="display:grid; gap:6px;">
          <div style="display:grid; gap:4px;">
            <label for="qr_name" style="font-weight:700;">Fullname</label>
            <input id="qr_name" name="name" type="text" placeholder="John Doe" required
              style="width:100%; padding:6px 10px; background: var(--surface); border:1px solid var(--border); border-radius:12px; color:var(--text);" />
          </div>
          <div style="display:grid; gap:4px;">
            <label for="qr_phone" style="font-weight:700;">Phone number</label>
            <input id="qr_phone" name="phone" type="tel" inputmode="tel" placeholder="0803 123 4567" required
              style="width:100%; padding:6px 10px; background: var(--surface); border:1px solid var(--border); border-radius:12px; color:var(--text);" />
          </div>
          <div style="display:grid; gap:4px;">
            <label for="qr_gmail" style="font-weight:700;">Gmail</label>
            <input id="qr_gmail" name="gmail" type="email" placeholder="example@gmail.com" required
              style="width:100%; padding:6px 10px; background: var(--surface); border:1px solid var(--border); border-radius:12px; color:var(--text);" />
          </div>
          <div style="margin-top:4px;">
            <button id="qr_btn" type="submit" class="btn primary" style="width:100%; padding:8px 10px;">Submit</button>
          </div>
          <div id="qr_ok" style="display:none;margin-top:6px;padding:8px;border-radius:10px;background:rgba(16,185,129,.12);border:1px solid rgba(16,185,129,.35);">✅ Thanks! Your details were received.</div>
          <div id="qr_err" style="display:none;margin-top:6px;padding:8px;border-radius:10px;background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.35);">⚠️ Couldn’t submit. Please try again.</div>
          <p class="small" style="font-size:.85rem;opacity:.8;margin:4px 0 0;">Note: This posts securely to our Google Apps Script endpoint — no page reload.</p>
        </form>
      `, false));
      input.focus();
    }

    function containsAny(str, arr){
      const L = str.toLowerCase();
      return arr.some(w => L.includes(w.toLowerCase()));
    }

    function typingThenGlobal(cb){
      __composerLock(true);
      const t = appendMessage('bot', `<em>Magnus Platform is typing<span class="dots">.....</span></em>`);
      const d = t.querySelector('.dots');
      let c = 1;
      const tm = setInterval(()=>{ c=(c%5)+1; d.textContent='.'.repeat(c); }, 500);
      setTimeout(()=>{
        clearInterval(tm);
        t.parentElement.remove();
        __composerLock(false);
        cb && cb();
      }, 6000);
    }

    function showProofSequence(){
      let i = 1;
      const next = () => {
        if (i > 5) return;
        typingThenGlobal(()=>{
          appendMessage('bot', proofCardHTML(i));
          i++;
          next();
        });
      };
      next();
    }

    const countryPrompt = `Reply with the name of your country only so that you can proceed with registration.

Countries available:
1. Liberia 🇱🇷
2. Kenya 🇰🇪
3. Ghana 🇬🇭
4. Cameroon 🇨🇲
5. Uganda 🇺🇬 | Tanzania 🇹🇿
6. South Africa 🇿🇦 | Nigeria 🇳🇬
7. Sierra Leone 🇸🇱
8. Ivory Coast 🇨🇮 | Togo 🇹🇬 | Benin 🇧🇯 | Mali 🇲🇱 | Burkina Faso 🇧🇫 | Guinea-Bissau 🇬🇼 | Senegal 🇸🇳 | Niger 🇳🇪
9. The Gambia 🇬🇲
10. Zimbabwe 🇿🇼

Which country are you from? Reply with the name only.`;

    let expectingCountry = false;
    let paymentDetailsShown = false;
    let proofCTAShown = false;

    const countryAccounts = {
      nigeria: { label: 'Nigeria', bank: 'GTBank (Demo)', number: '0123456789', name: 'Magnus Platform Demo' },
      southafrica: { label: 'South Africa', bank: 'Standard Bank (Demo)', number: '000123456789', name: 'Magnus Platform Demo' },
      kenya: { label: 'Kenya', bank: 'KCB (Demo)', number: '1102345678', name: 'Magnus Platform Demo' },
      ghana: { label: 'Ghana', bank: 'GCB Bank (Demo)', number: '0234567890', name: 'Magnus Platform Demo' },
      uganda: { label: 'Uganda', bank: 'Stanbic Uganda (Demo)', number: '3102345678', name: 'Magnus Platform Demo' },
      tanzania: { label: 'Tanzania', bank: 'CRDB (Demo)', number: '4102345678', name: 'Magnus Platform Demo' },
      liberia: { label: 'Liberia', bank: 'Ecobank Liberia (Demo)', number: '1002345678', name: 'Magnus Platform Demo' },
      cameroon: { label: 'Cameroon', bank: 'UBA Cameroon (Demo)', number: '2002345678', name: 'Magnus Platform Demo' },
      sierraleone: { label: 'Sierra Leone', bank: 'Sierra Leone Commercial Bank (Demo)', number: '5202345678', name: 'Magnus Platform Demo' },
      ivorycoast: { label: 'Ivory Coast', bank: 'Ecobank Côte d’Ivoire (Demo)', number: '5302345678', name: 'Magnus Platform Demo' },
      cotedivoire: { label: 'Côte d’Ivoire', bank: 'Ecobank Côte d’Ivoire (Demo)', number: '5302345678', name: 'Magnus Platform Demo' },
      togo: { label: 'Togo', bank: 'Ecobank Togo (Demo)', number: '5402345678', name: 'Magnus Platform Demo' },
      benin: { label: 'Benin', bank: 'Bank of Africa Benin (Demo)', number: '5502345678', name: 'Magnus Platform Demo' },
      mali: { label: 'Mali', bank: 'BNDA (Demo)', number: '5602345678', name: 'Magnus Platform Demo' },
      burkinafaso: { label: 'Burkina Faso', bank: 'Coris Bank (Demo)', number: '5702345678', name: 'Magnus Platform Demo' },
      guineabissau: { label: 'Guinea-Bissau', bank: 'BAO Guinea-Bissau (Demo)', number: '5802345678', name: 'Magnus Platform Demo' },
      senegal: { label: 'Senegal', bank: 'Ecobank Senegal (Demo)', number: '5902345678', name: 'Magnus Platform Demo' },
      niger: { label: 'Niger', bank: 'Bank of Africa Niger (Demo)', number: '6002345678', name: 'Magnus Platform Demo' },
      gambia: { label: 'The Gambia', bank: 'Trust Bank Gambia (Demo)', number: '6102345678', name: 'Magnus Platform Demo' },
      thegambia: { label: 'The Gambia', bank: 'Trust Bank Gambia (Demo)', number: '6102345678', name: 'Magnus Platform Demo' },
      zimbabwe: { label: 'Zimbabwe', bank: 'CBZ Bank (Demo)', number: '6202345678', name: 'Magnus Platform Demo' }
    };

    function canonicalizeCountry(str){
      return str
        .toLowerCase()
        .normalize('NFD').replace(/\p{Diacritic}/gu,'')
        .replace(/[^a-z]/g,''); // letters only
    }

    function findCountryAccount(input){
      const c = canonicalizeCountry(input);
      for (const key in countryAccounts){
        if (c === key || c.includes(key) || key.includes(c)){
          return countryAccounts[key];
        }
      }
      return null;
    }

    /* CTA card for proof submission */
    function submitProofCTAHTML(){
      return `<div class="card" role="region" aria-label="Submit proof">
        <div class="actions">
          <button class="btn primary">submit proof of payment to get access and start earning</button>
        </div>
      </div>`;
    }

    function bankCardHTML(acct){
      return buildCard(`Payment Details — ${acct.label}`, `
        <ul>
          <li><strong>Account Name:</strong> <span class="val-name">${acct.name}</span>
            <button class="btn secondary" data-action="copy-field" data-label="Account Name" data-value="${acct.name}" style="padding:6px 10px; margin-left:8px; font-size:.85em;">Copy</button>
          </li>
          <li><strong>Bank:</strong> <span class="val-bank">${acct.bank}</span>
            <button class="btn secondary" data-action="copy-field" data-label="Bank" data-value="${acct.bank}" style="padding:6px 10px; margin-left:8px; font-size:.85em;">Copy</button>
          </li>
          <li><strong>Account Number:</strong> <code class="val-num" style="font-weight:700">${acct.number}</code>
            <button class="btn secondary" data-action="copy-field" data-label="Account Number" data-value="${acct.number}" style="padding:6px 10px; margin-left:8px; font-size:.85em;">Copy</button>
          </li>
          <li style="color:var(--muted)"><em>Note:</em> Demo account for onboarding/testing.</li>
        </ul>
        <div class="actions" style="margin-top:12px;">
          <button class="btn primary">I have made the payment</button>
        </div>
      `, false);
    }

    chat.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;
      const action = btn.dataset.action;
      if (action === 'choose') {
        appendMessage('user', 'I Choose this package');
        showProofSequence();
      } else if (action === 'ready') {
        appendMessage('user', 'I am ready');
        appendMessage('bot', countryPrompt);
        expectingCountry = true; __saveFlags();
      }
    });

    /* Per-field copy handler: copy only the value */
    chat.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-action="copy-field"]');
      if (!btn) return;
      const value = btn.dataset.value || '';
      const text = value;

      const fallbackCopy = (t) => {
        const ta = document.createElement('textarea');
        ta.value = t;
        ta.style.position = 'fixed';
        ta.style.left = '-9999px';
        document.body.appendChild(ta);
        ta.select();
        try { document.execCommand('copy'); } catch(e) {}
        document.body.removeChild(ta);
      };

      if (navigator.clipboard && window.isSecureContext !== false) {
        navigator.clipboard.writeText(text).then(() => {}).catch(() => fallbackCopy(text));
      } else {
        fallbackCopy(text);
      }
      const original = btn.textContent;
      btn.textContent = 'Copied!';
      setTimeout(() => { btn.textContent = 'Copy'; }, 1200);
    });

    /* Click on "I have made the payment" -> show CTA */
    chat.addEventListener('click', (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;
      if (btn.textContent && btn.textContent.trim().toLowerCase() === 'i have made the payment') {
        appendMessage('bot', submitProofCTAHTML());
        proofCTAShown = true; __saveFlags();
      }
    });

    // === Registration form handler (delegated) ===
    const REG_ENDPOINT = 'https://script.google.com/macros/s/AKfycbw1LW-9Zz4RbZyyzdM9wYX6ObrP7o7Ooeqv1hKN-BW3DOxkHIOn8jMcO9o_Y-tyax6k/exec';

    function __toFormEncoded(data){
      return Object.keys(data).map(k => encodeURIComponent(k)+'='+encodeURIComponent(data[k])).join('&');
    }

    chat.addEventListener('submit', async (ev) => {
      const formEl = ev.target;
      if (!formEl || formEl.id !== 'quickRegForm') return;
      ev.preventDefault();

      const name  = (formEl.querySelector('#qr_name')  || {}).value?.trim() || '';
      const phone = (formEl.querySelector('#qr_phone') || {}).value?.trim() || '';
      const gmail = (formEl.querySelector('#qr_gmail') || {}).value?.trim() || '';
      const btn   = formEl.querySelector('#qr_btn');
      const okEl  = formEl.querySelector('#qr_ok');
      const errEl = formEl.querySelector('#qr_err');

      if (!name || !phone || !gmail){ alert('Please fill all fields.'); return; }
      if (!/@gmail\.com\s*$/i.test(gmail)){ alert('Please enter a Gmail address (must end with @gmail.com).'); return; }

      if (okEl) okEl.style.display = 'none';
      if (errEl) errEl.style.display = 'none';
      if (btn){ btn.disabled = true; btn.textContent = 'Submitting...'; }

      try{
        const res = await fetch(REG_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
          body: __toFormEncoded({ name, phone, gmail })
        });
        if (res.ok){
          window.__unlockChatAfterForm && window.__unlockChatAfterForm();

          if (okEl) okEl.style.display = 'block';
          formEl.reset();

          // After 2 seconds, hide the form but keep success visible, then show intro video + save-contacts instructions as a normal message
          setTimeout(() => {
            Array.from(formEl.children).forEach(node => {
              if (node.id !== 'qr_ok') { node.style.display = 'none'; }
              else { node.style.display = 'block'; }
            });

            const firstName = (name || '').trim().split(/\s+/)[0] || 'there';
            window.__firstName = firstName; window.__fullName = name; window.__phone = phone; window.__gmail = gmail;

            // Intro clip before the instructions
            appendMessage('bot', buildCard('Quick Intro Video', `
              <p style="margin:0 0 8px 0;">follow this instructions to save contacts for successful registration.</p>
              <video src="https://www.w3schools.com/html/mov_bbb.mp4" controls autoplay playsinline style="width:100%;height:auto;border:1px solid var(--border);border-radius:12px"></video>
            `, false));

            // Instructions card with Click to Save
            const wrapper = appendMessage('bot', buildCard('Save our contacts', `
              <p>Hi ${firstName}, save our contacts so you can receive your logins and start earning immediately after registration.</p>
              <ul>
                <li><strong>Android:</strong> tap <em>Click to Save</em> and import the .vcf when prompted.</li>
                <li><strong>iPhone:</strong> tap <em>Click to Save</em> → “Allow” → “Add All Contacts”.</li>
                <li><strong>Desktop:</strong> download the .vcf and open it to add to your contacts.</li>
              </ul>
              <div class="actions">
                <button class="btn primary save-contact-btn" type="button">Click to Save</button>
              </div>
            `, false));

            const saveBtn = wrapper.querySelector('.save-contact-btn');
            if (saveBtn){
              saveBtn.addEventListener('click', async () => {
                // Build a single VCF file containing two contacts
                const num = '091 69694832'.replace(/\s+/g,'');
                const vcf = [
                  'BEGIN:VCARD',
                  'VERSION:3.0',
                  'N:Media1;Mentor;;;',
                  'FN:Mentor Media1',
                  'TEL;TYPE=CELL:' + num,
                  'END:VCARD',
                  'BEGIN:VCARD',
                  'VERSION:3.0',
                  'N:Media2;Mentor;;;',
                  'FN:Mentor Media 2',
                  'TEL;TYPE=CELL:' + num,
                  'END:VCARD'
                ].join('\n');

                try{
                  const blob = new Blob([vcf], { type: 'text/vcard;charset=utf-8' });
                  const url = URL.createObjectURL(blob);
                  const a = document.createElement('a');
                  a.href = url;
                  a.download = 'Mentor-Media-contacts.vcf';
                  document.body.appendChild(a);
                  a.click();
                  setTimeout(() => {
                    URL.revokeObjectURL(url);
                    a.remove();
                  }, 3000);
                }catch(e){
                  const dataUrl = 'data:text/vcard;charset=utf-8,' + encodeURIComponent(vcf);
                  window.location.href = dataUrl;
                }

                // Keep the instructions; then show follow-up after typing
                typingThenGlobal(() => {
                  window.awaitingDone = true;
                  appendMessage('bot', buildCard('Next Step', `
                    <p>if you have saved the contact click on the done button below.</p>
                    <div class="actions">
                      <button class="btn primary" data-action="done">Done!!</button>
                    </div>
                  `, false));
                });
              });
            }

          }, 2000);
        }else{
          if (errEl) errEl.style.display = 'block';
        }
      }catch(e){
        if (errEl) errEl.style.display = 'block';
      }finally{
        if (btn){ btn.disabled = false; btn.textContent = 'Submit'; }
      }
    });

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const text = input.value.trim();
      if (!text) return;
      appendMessage('user', escapeHTML(text));

      __composerLock(true);
      const typingBubble = appendMessage('bot', `<em>Magnus Platform is typing<span class="dots">.....</span></em>`);
      const dotsEl = typingBubble.querySelector('.dots');
      let dotCount = 1;
      const dotsTimer = setInterval(() => {
        dotCount = (dotCount % 5) + 1;
        dotsEl.textContent = '.'.repeat(dotCount);
      }, 500);

      setTimeout(() => {
        clearInterval(dotsTimer);
        typingBubble.parentElement.remove();
        __composerLock(false);

        // If we're waiting for Done, any reply counts as Done
        if (window.awaitingDone === true) {
          window.awaitingDone = false;
          const nameX = ((window.__fullName || window.__firstName || text) || '').trim();
          const helloX = nameX ? `Nice to meet you, <strong>${escapeHTML(nameX)}</strong>!` : `Great!`;
          if (window.howItWorksShown) {
            appendMessage('bot', `Are you sure you are following my instructions?<br><strong>Use exactly:</strong> <em>I Choose this package</em> or <em>I am ready</em>.`);
            input.value=''; input.focus(); return;
          }
          window.howItWorksShown = true;
          appendMessage('bot', `${helloX} Here’s how <strong>Magnus Platform</strong> works:`);
          typingThenGlobal(()=>{
            appendMessage('bot', buildCard('Step 1 — Get Started', `
              <ul>
                <li><strong>Register</strong> in minutes — simple onboarding to get you started.</li>
                <li><strong>Create your profile</strong> and unlock tasks immediately.</li>
              </ul>
            `, false));
            typingThenGlobal(()=>{
              appendMessage('bot', buildCard('Step 2 — Start Earning', `
                <ul>
                  <li><strong>Earn with tasks</strong> — smartphone jobs, streaming jobs, and referrals.</li>
                  <li><strong>Fast withdrawals</strong> — quick, secure payouts when you’re ready.</li>
                </ul>
              `, false));
              typingThenGlobal(()=>{
                appendMessage('bot', buildCard('Step 3 — Grow Bigger', `
                  <ul>
                    <li><strong>Grow</strong> — level up by completing tasks consistently.</li>
                    <li><strong>Scale your income</strong> with bonuses and referrals.</li>
                  </ul>
                `, false));
                typingThenGlobal(()=>{
                  appendMessage('bot', buildCard('Step 4 — Unlock Bonuses', `
                    <ul>
                      <li><strong>Daily goals</strong> — hit milestones for streak rewards.</li>
                      <li><strong>Referral boosts</strong> — share your code to multiply earnings.</li>
                    </ul>
                    <div class="actions" style="margin-top:10px;">
                      <button class="btn primary" data-action="choose">I Choose this package</button>
                    </div>
                  `, false));
                  typingThenGlobal(()=>{
                    appendMessage('bot', buildCard('Step 5 — Quick Video', `
                      <p style="margin:0 0 8px 0;">Watch this quick clip, then proceed when you're ready.</p>
                      <video src="https://www.w3schools.com/html/mov_bbb.mp4" controls autoplay playsinline style="width:100%;height:auto;border:1px solid var(--border);border-radius:12px"></video>
                      <div class="actions" style="margin-top:10px;">
                        <button class="btn secondary" data-action="ready">I am ready</button>
                      </div>
                    `, false));
                  });
                });
              });
            });
          });
          input.value=''; input.focus(); return;
        }

                /* Direct country mention -> immediately show payment details (new) */
        const __acctDirect = findCountryAccount(text);
        if (!expectingCountry && __acctDirect){
          appendMessage('bot', bankCardHTML(__acctDirect));
          paymentDetailsShown = true; proofCTAShown = false;
          expectingCountry = false; __saveFlags(); setTimeout(() => { __startPaymentCountdown(); }, 4000);
          input.value = ''; input.focus(); return;
        }

        if (expectingCountry){
          const acct = findCountryAccount(text);
          if (acct){
            appendMessage('bot', bankCardHTML(acct));
            paymentDetailsShown = true; proofCTAShown = false;
            expectingCountry = false; __saveFlags(); setTimeout(() => { __startPaymentCountdown(); }, 4000);
            input.value = '';
            input.focus();
            return;
          } else {
            appendMessage('bot', buildCard('Country Not Found', `
              <p>Please reply with the <strong>country name only</strong> from the list above.</p>
            `, false));
            input.value = '';
            input.focus();
            return;
          }
        }

        /* After payment details, any next message should receive the proof submission CTA once */
        if (paymentDetailsShown && !proofCTAShown){
          appendMessage('bot', submitProofCTAHTML());
          proofCTAShown = true; __saveFlags();
          input.value = '';
          input.focus();
          return;
        }

        const negative = ["fake","scam","scammer","prove","withdraw","proof","fraud"];
        const positive = ["ready","register","start","how to","signup","join","earn","member","create","account","code","registration fee","fee"];

        if (containsAny(text, negative)) {
          showProofSequence();
          input.value = '';
          input.focus();
          return;
        }
        if (containsAny(text, positive)) {
          appendMessage('bot', countryPrompt);
          expectingCountry = true; __saveFlags();
          input.value = '';
          input.focus();
          return;
        }

        const hello = text ? `Nice to meet you, <strong>${escapeHTML(text)}</strong>!` : `Great!`;
        if (window.howItWorksShown) {
          appendMessage('bot', `Are you sure you are following my instructions?<br><strong>Use exactly:</strong> <em>I Choose this package</em> or <em>I am ready</em>.`);
          input.value = '';
          input.focus();
          return;
        }
        window.howItWorksShown = true;
        appendMessage('bot', `${hello} Here’s how <strong>Magnus Platform</strong> works:`);

        function typingThen(cb){
          __composerLock(true);
          const t = appendMessage('bot', `<em>Magnus Platform is typing<span class="dots">.....</span></em>`);
          const d = t.querySelector('.dots');
          let c = 1;
          const tm = setInterval(()=>{ c=(c%5)+1; d.textContent='.'.repeat(c); }, 500);
          setTimeout(()=>{
            clearInterval(tm);
            t.parentElement.remove();
            __composerLock(false);
            cb && cb();
          }, 6000);
        }

        typingThen(()=>{
          appendMessage('bot', buildCard('Step 1 — Get Started', `
            <ul>
              <li><strong>Register</strong> in minutes — simple onboarding to get you started.</li>
              <li><strong>Create your profile</strong> and unlock tasks immediately.</li>
            </ul>
          `, false));

          typingThen(()=>{
            appendMessage('bot', buildCard('Step 2 — Start Earning', `
              <ul>
                <li><strong>Earn with tasks</strong> — smartphone jobs, streaming jobs, and referrals.</li>
                <li><strong>Fast withdrawals</strong> — quick, secure payouts when you’re ready.</li>
              </ul>
            `, false));

            typingThen(()=>{
              appendMessage('bot', buildCard('Step 3 — Grow Bigger', `
                <ul>
                  <li><strong>Grow</strong> — level up by completing tasks consistently.</li>
                  <li><strong>Scale your income</strong> with bonuses and referrals.</li>
                </ul>
              `, false));

              typingThen(()=>{
                appendMessage('bot', buildCard('Step 4 — Unlock Bonuses', `
                  <ul>
                    <li><strong>Daily goals</strong> — hit milestones for streak rewards.</li>
                    <li><strong>Referral boosts</strong> — share your code to multiply earnings.</li>
                  </ul>
                  <div class="actions" style="margin-top:10px;">
                    <button class="btn primary" data-action="choose">I Choose this package</button>
                  </div>
                `, false));

                typingThen(()=>{
                  appendMessage('bot', buildCard('Step 5 — Quick Video', `
                    <p style="margin:0 0 8px 0;">Watch this quick clip, then proceed when you're ready.</p>
                    <video src="https://www.w3schools.com/html/mov_bbb.mp4" controls autoplay playsinline style="width:100%;height:auto;border:1px solid var(--border);border-radius:12px"></video>
                    <div class="actions" style="margin-top:10px;">
                      <button class="btn secondary" data-action="ready">I am ready</button>
                    </div>
                  `, false));
                });
              });
            });
          });
        });

      }, 6000);

      input.value = '';
      input.focus();
    });

    // Fetch IP and restore chat; greet still handles first-time
    window.addEventListener('DOMContentLoaded', () => {
    /* === Revisit count + Popup cycle (added) === */

    function __installRestartButton(){
      try{
        const bar = document.querySelector('.bar');
        if (!bar) return;
        let btn = document.getElementById('restartBtn');
        if (!btn){
          btn = document.createElement('button');
          btn.id = 'restartBtn';
          btn.className = 'restart-btn';
          btn.type = 'button';
          btn.textContent = 'Restart chat';
          bar.appendChild(btn);
          btn.addEventListener('click', __restartChat);
        }
      }catch(e){}
    }

    function __restartChat(){
      try{
        // Remove floating widgets / promos
        const floater = document.querySelector('.mpc-floater'); if (floater) floater.remove();
        document.querySelectorAll('.promo').forEach(n => n.remove());
        const pBadge = document.getElementById('promoBadge'); if (pBadge) pBadge.remove();
        // Reset chat DOM
        chat.innerHTML = '';
        // Reset flags
        window.howItWorksShown = false;
        window.paymentDetailsShown = false;
        window.proofCTAShown = false;
        window.expectingCountry = false;
        window.__magnusRestored = false;
        // Clear persisted items for this IP
        try{
          localStorage.removeItem(__key());
          localStorage.removeItem(__key('flags'));
          localStorage.removeItem(__key('countdownEnd'));
          localStorage.removeItem(__key('floaterPos'));
          localStorage.removeItem(__key('floaterMin'));
          localStorage.setItem(__key('visits'), '0'); // reset revisits
        }catch(e){}
        // Refresh navbar badge to 0
        __updateVisitBadge(0);
        // Save fresh flags and show greeting
        try{ __saveFlags(); }catch(e){}
        try{ greet(); }catch(e){}
        input.focus();
      }catch(e){}
    }

    function __updateVisitBadge(revisits){
      try{
        const bar = document.querySelector('.bar .sub') || document.querySelector('.bar');
        if (!bar) return;
        let badge = document.getElementById('visitBadge');
        if (!badge){
          badge = document.createElement('span');
          badge.id = 'visitBadge';
          badge.className = 'visit-badge';
          bar.appendChild(badge);
        }
        badge.textContent = `Revisits: ${revisits}`;
        __installRestartButton();
      }catch(e){}
    }

    function __nextRevisitIndex(visits){
      // visits: 1 = first visit (not a revisit); 2 = first revisit; 3 = second, etc.
      // Sequence for revisits: 0 (img1), 1 (img2), 2 (video1), 3 (video2), repeat
      if (visits < 2) return -1;
      return (visits - 2) % 4;
    }

    function __promoHTML(kind, idx){
      const titles = [
        'Welcome Back #1',
        'Welcome Back #2',
        'Quick Demo Clip',
        'Member Story'
      ];
      const texts = [
        'Fresh tips to increase your earnings today.',
        'See how top members ramp up faster.',
        'A 30s look at the dashboard basics.',
        'How consistent tasks compound results.'
      ];
      if (kind === 'image'){
        const seed = `promo_${idx+1}_${Date.now()%10000}`;
        return `<div class="promo" role="dialog" aria-modal="true">
          <div class="promo-card">
            <div class="promo-head">
              <div>Magnus CEO</div>
              <button class="promo-close" title="Minimize" aria-label="Minimize">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M18.3 5.71 12 12.01l-6.29-6.3-1.42 1.42 6.3 6.29-6.3 6.29 1.42 1.42 6.29-6.3 6.29 6.3 1.42-1.42-6.3-6.29 6.3-6.29z"/></svg>
              </button>
            </div>
            <div class="promo-body">
              <figure>
                <img src="https://picsum.photos/seed/${seed}/600/600" alt="Welcome back illustration">
                <figcaption>
                  <h1>${titles[idx%titles.length]}</h1>
                  <p>${texts[idx%texts.length]}</p>
                </figcaption>
                <div class="promo-actions" style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap;">
                  <button class="btn secondary promo-remove" type="button">click here to remove the video</button>
                  <button class="btn primary promo-register" type="button">Click here to register and earn fast</button>
                </div>
              </figure>
            </div>
          </div>
        </div>`;
      } else {
        const vids = [
          'https://www.w3schools.com/html/mov_bbb.mp4',
          'https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4'
        ];
        const vsrc = vids[idx % vids.length];
        return `<div class="promo" role="dialog" aria-modal="true">
          <div class="promo-card">
            <div class="promo-head">
              <div>Magnus CEO</div>
              <button class="promo-close" title="Minimize" aria-label="Minimize">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M18.3 5.71 12 12.01l-6.29-6.3-1.42 1.42 6.3 6.29-6.3 6.29 1.42 1.42 6.29-6.3 6.29 6.3 1.42-1.42-6.3-6.29 6.3-6.29z"/></svg>
              </button>
            </div>
            <div class="promo-body">
              <figure>
                <video src="${vsrc}" controls autoplay playsinline></video>
                <figcaption>
                  <h1>${titles[(idx+2)%titles.length]}</h1>
                  <p>${texts[(idx+2)%texts.length]}</p>
                </figcaption>
                <div class="promo-actions" style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap;">
                  <button class="btn secondary promo-remove" type="button">click here to remove the video</button>
                  <button class="btn primary promo-register" type="button">Click here to register and earn fast</button>
                </div>
              </figure>
            </div>
          </div>
        </div>`;
      }
    }

    function __showRevisitPopup(visits){
      const idx = __nextRevisitIndex(visits);
      if (idx < 0) return; // first visit: no popup

      const kind = (idx < 2) ? 'image' : 'video';
      const wrapper = document.createElement('div');
      wrapper.innerHTML = __promoHTML(kind, idx);
      const node = wrapper.firstElementChild;
      document.body.appendChild(node);

      const closeBtn = node.querySelector('.promo-close');
      const card = node.querySelector('.promo-card');
      function minimize(){
        // "Minimize": hide overlay and leave a small corner badge the user can re-open
        node.style.display = 'none';
        // Add a tiny floating badge bottom-left
        let badge = document.getElementById('promoBadge');
        if (!badge){
          badge = document.createElement('button');
          badge.id = 'promoBadge';
          badge.setAttribute('type','button');
          badge.textContent = 'Open promo';
          badge.style.position='fixed'; badge.style.left='12px'; badge.style.bottom='88px';
          badge.style.zIndex='1001'; badge.style.padding='8px 10px'; badge.style.borderRadius='10px';
          badge.style.border='1px solid var(--border)'; badge.style.background='rgba(0,0,0,0.7)'; badge.style.color='var(--text)';
          document.body.appendChild(badge);
          badge.addEventListener('click', ()=>{ node.style.display='flex'; badge.remove(); });
        }
      }
      if (closeBtn){
        closeBtn.addEventListener('click', minimize);
      }
      // Extra handlers for video popups
      {
        if (kind === 'video'){
          const vid = node.querySelector('video');
          if (vid){
            try { vid.muted = false; vid.volume = 1.0; vid.autoplay = true; } catch(e){}
            const tryPlay = () => { const p = vid.play(); if (p && p.catch) { p.catch(()=>{}); } };
            tryPlay();
            const resume = () => { try { vid.muted = false; vid.volume = 1.0; tryPlay(); } catch(e){} document.removeEventListener('click', resume); };
            document.addEventListener('click', resume, {once:true});
          }
        }
        const removeBtn = node.querySelector('.promo-remove');
        if (removeBtn){ removeBtn.addEventListener('click', () => { node.remove(); }); }
        const regBtn = node.querySelector('.promo-register');
        if (regBtn){ regBtn.addEventListener('click', () => {
          appendMessage('user', 'I am ready');
          appendMessage('bot', countryPrompt);
          expectingCountry = true; try{ __saveFlags(); }catch(e){}
          node.remove();
        }); }
      }
    }

      __getIP().then(() => { __restoreChat(); __saveFlags(); let visits = parseInt(localStorage.getItem(__key('visits'))||'0',10); visits = isNaN(visits) ? 0 : visits; visits += 1; localStorage.setItem(__key('visits'), String(visits)); __updateVisitBadge(Math.max(0, visits - 1)); __installRestartButton(); __showRevisitPopup(visits); if (window.paymentDetailsShown) { __startPaymentCountdown(); const f=document.querySelector('.mpc-floater'); if (f) __attachFloaterControls(f); } });
    });

    // Upload image icon -> file chooser; redirect to chat with prefilled text
    (function(){
      const ub = document.getElementById('uploadBtn');
      const fi = document.getElementById('uploadImage');
      if (ub && fi){
        ub.addEventListener('click', () => fi.click());
        fi.addEventListener('change', () => {
          const f = fi.files && fi.files[0];
          if (!f) return;

          // Build default message from submitted details
          const name  = (window.__fullName || window.__firstName || '(not provided)').trim();
          const phone = (window.__phone || '(not provided)').toString();
          const gmail = (window.__gmail || '(not provided)').toString();

          let lines = [];
          lines.push('--- Magnus Platform Registration Details ---');
          lines.push('Full Name: ' + name);
          lines.push('Phone: ' + phone);
          lines.push('Gmail: ' + gmail);
          lines.push('');
          lines.push('Status: I have completed the payment.');
          lines.push('');
          lines.push('👉 Please upload your proof of payment (screenshot/receipt) here on WhatsApp so we can verify and activate your access.');
          const text = lines.join('\n');

          function toIntl(n){
            const digits = String(n).replace(/\D+/g,'');
            if (digits.startsWith('234')) return digits;
            if (digits.startsWith('0')) return '234' + digits.slice(1);
            return digits;
          }

          const targetRaw = '09160014944';
          const waUrl = 'https://wa.me/' + toIntl(targetRaw) + '?text=' + encodeURIComponent(text);

          try {
            window.location.href = waUrl;
          } catch (e) {
            const smsUrl = 'sms:' + targetRaw + '?body=' + encodeURIComponent(text);
            window.location.href = smsUrl;
          }
          fi.value = '';
        });
      }
    })();

    // Start steps when user clicks Done!!
    chat.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-action="done"]');
      if (!btn) return;

      appendMessage('user', 'Done!!');

      if (window.howItWorksShown) {
        appendMessage('bot', `Are you sure you are following my instructions?<br><strong>Use exactly:</strong> <em>I Choose this package</em> or <em>I am ready</em>.`);
        return;
      }

      const name = (window.__fullName || window.__firstName || '').trim();
      const hello = name ? `Nice to meet you, <strong>${escapeHTML(name)}</strong>!` : `Great!`;
      window.howItWorksShown = true;
      appendMessage('bot', `${hello} Here’s how <strong>Magnus Platform</strong> works:`);

      typingThenGlobal(()=>{
        appendMessage('bot', buildCard('Step 1 — Get Started', `
          <ul>
            <li><strong>Register</strong> in minutes — simple onboarding to get you started.</li>
            <li><strong>Create your profile</strong> and unlock tasks immediately.</li>
          </ul>
        `, false));

        typingThenGlobal(()=>{
          appendMessage('bot', buildCard('Step 2 — Start Earning', `
            <ul>
              <li><strong>Earn with tasks</strong> — smartphone jobs, streaming jobs, and referrals.</li>
              <li><strong>Fast withdrawals</strong> — quick, secure payouts when you’re ready.</li>
            </ul>
          `, false));

          typingThenGlobal(()=>{
            appendMessage('bot', buildCard('Step 3 — Grow Bigger', `
              <ul>
                <li><strong>Grow</strong> — level up by completing tasks consistently.</li>
                <li><strong>Scale your income</strong> with bonuses and referrals.</li>
              </ul>
            `, false));

            typingThenGlobal(()=>{
              appendMessage('bot', buildCard('Step 4 — Unlock Bonuses', `
                <ul>
                  <li><strong>Daily goals</strong> — hit milestones for streak rewards.</li>
                  <li><strong>Referral boosts</strong> — share your code to multiply earnings.</li>
                </ul>
                <div class="actions" style="margin-top:10px;">
                  <button class="btn primary" data-action="choose">I Choose this package</button>
                </div>
              `, false));

              typingThenGlobal(()=>{
                appendMessage('bot', buildCard('Step 5 — Quick Video', `
                  <p style="margin:0 0 8px 0;">Watch this quick clip, then proceed when you're ready.</p>
                  <video src="https://www.w3schools.com/html/mov_bbb.mp4" controls autoplay playsinline style="width:100%;height:auto;border:1px solid var(--border);border-radius:12px"></video>
                  <div class="actions" style="margin-top:10px;">
                    <button class="btn secondary" data-action="ready">I am ready</button>
                  </div>
                `, false));
              });
            });
          });
        });
      });
    });

    window.addEventListener('DOMContentLoaded', greet);
  
    /* === Busy guard: prevent button clicks while Magnus is typing / action running === */
    (function(){
      try{
        var __origLock = window.__composerLock;
        window.__magnusBusy = false;

        function __setButtonsDisabled(dis){
          try{
            document.querySelectorAll('button').forEach(function(b){
              b.disabled = !!dis;
              b.style.opacity = dis ? 0.6 : '';
              b.style.cursor = dis ? 'not-allowed' : '';
            });
          }catch(e){}
        }

        // Wrap the existing composer lock to also toggle global busy & buttons
        window.__composerLock = function(on){
          try{ if (typeof __origLock === 'function') __origLock(on); }catch(e){}
          window.__magnusBusy = !!on;
          __setButtonsDisabled(!!on);
        };

        // Capture all button-like clicks while busy and block them
        document.addEventListener('click', function(e){
          if (window.__magnusBusy){
            var el = e.target && (e.target.closest('button, .btn, [data-action]'));
            if (el){
              e.preventDefault();
              e.stopImmediatePropagation();
              alert('Please wait — Magnus is still typing.');
              return false;
            }
          }
        }, true);
      }catch(e){}
    })();

</script>
</body>
</html>